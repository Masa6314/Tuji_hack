<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>{{ page_title }}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-6">
    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
    <h1 class="text-2xl font-bold mb-6">{{ page_title }}</h1>
    <!-- ===== å€‹äººã®çŠ¶æ…‹ï¼ˆæ¨ªé•·ã‚«ãƒ¼ãƒ‰ï¼‰ ===== -->
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-2">{{user_name}}ã®çŠ¶æ…‹</h2>
      <div class="text-sm text-gray-500 mb-2">
        èµ¤=è¦å¯¾å¿œ / é»„=æ³¨æ„ / ç·‘=è‰¯å¥½ / ç°=æœªå›ç­”
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {% for u in users_overview %}
        <div class="border rounded-lg p-4 shadow-sm
                    {% if u.risk == 'high' %}border-red-400 bg-red-50
                    {% elif u.risk == 'mid' %}border-yellow-400 bg-yellow-50
                    {% elif u.risk == 'low' %}border-green-400 bg-green-50
                    {% else %}border-gray-300 bg-gray-50{% endif %}">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-lg">{{ u.display_name }}</div>
            <span class="text-xs px-2 py-1 rounded
              {% if u.risk == 'high' %}bg-red-500 text-white
              {% elif u.risk == 'mid' %}bg-yellow-500 text-white
              {% elif u.risk == 'low' %}bg-green-500 text-white
              {% else %}bg-gray-400 text-white{% endif %}">
              {% if u.risk == 'high' %}è¦å¯¾å¿œ
              {% elif u.risk == 'mid' %}æ³¨æ„
              {% elif u.risk == 'low' %}è‰¯å¥½
              {% else %}æœªå›ç­”{% endif %}
            </span>
          </div>
          <div class="text-sm text-gray-600">æœ€çµ‚: {{ u.latest_at }}</div>
          <div class="mt-2 text-2xl font-bold">
            {{ u.latest_score if u.latest_score is not none else "-" }}
          </div>
          <div class="text-sm">{{ u.latest_status }}</div>
          <div class="mt-3 flex gap-2">
            <a href="/user/board/{{ u.external_token }}"
               class="bg-blue-500 text-white text-sm px-3 py-1 rounded">
               ç™’ã‚„ã—ã¦ã‚ã’ã‚‹
            </a>
            <button onclick="navigator.clipboard.writeText(
            '{{ request.url_root }}user/{{ u.external_token }}')"
            class="border text-sm px-3 py-1 rounded flex items-center gap-1 transition duration-150 hover:bg-gray-100 active:scale-95">
            :ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰: ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>


    <!-- ===== ç›´è¿‘ã®åˆ©ç”¨æ—¥æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆTOP3ï¼‰ ===== -->
    <div class="bg-white rounded-lg shadow p-4 mb-8">
      <h2 class="text-lg font-bold mb-3">ç›´è¿‘ã®åˆ©ç”¨æ—¥æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆTOP3ï¼‰</h2>
      <table class="min-w-full border border-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="border px-3 py-2 text-left">é †ä½</th>
            <th class="border px-3 py-2 text-left">åå‰</th>
            <th class="border px-3 py-2 text-right">ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ•°</th>
          </tr>
        </thead>
        <tbody>
          {% for row in login_ranking %}
          <tr class="hover:bg-gray-50">
            <td class="border px-3 py-2">
              {% if loop.index == 1 %}
                ğŸ¥‡: 1
              {% elif loop.index == 2 %}
                ğŸ¥ˆ: 2
              {% elif loop.index == 3 %}
                ğŸ¥‰: 3
              {% else %}
                {{ loop.index }}
              {% endif %}
            </td>
            <td class="border px-3 py-2">{{ row.display_name }}</td>
            <td class="border px-3 py-2 text-right">{{ row.days }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- ===== å›ç­”ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆè¿½åŠ ï¼‰ ===== -->
    <div id="answer-calendar"
         class="bg-white rounded-lg shadow p-4 mb-8"
         data-latest-at="{{ latest_at | e }}"
         data-latest-score="{{ latest_score if latest_score is not none else '' }}"
         data-chart-labels='{{ chart_labels|tojson }}'
         data-img-good="{{ url_for('static', filename='images/business_man1_4_laugh.png') }}"
         data-img-mid ="{{ url_for('static', filename='images/business_man1_1_smile.png') }}"
         data-img-bad ="{{ url_for('static', filename='images/business_man1_3_cry.png') }}">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold" id="cal-title">å›ç­”ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
        <div class="space-x-2 text-sm">
          <button id="cal-prev" class="px-3 py-1 rounded border hover:bg-gray-50">â† å‰æœˆ</button>
          <button id="cal-next" class="px-3 py-1 rounded border hover:bg-gray-50">ç¿Œæœˆ â†’</button>
        </div>
      </div>
      <div class="grid grid-cols-7 text-center text-xs font-medium text-gray-600 mb-2">
        <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
      </div>
      <style>
        .stamp-img { width: 100px; height: 70px; object-fit: contain; margin: 0 auto; }
      </style>
      <div id="cal-grid" class="grid grid-cols-7 gap-1"></div>
      <div id="cal-note" class="mt-3 text-xs text-gray-500"></div>
    </div>
    <!-- ===== ã‚¹ã‚³ã‚¢æ¨ç§»ï¼ˆç‚¹ï¼†ç·šã®è‰²ã‚’çŠ¶æ…‹è‰²ã«åŒæœŸï¼‰ ===== -->
    <div class="bg-white rounded-lg shadow p-4 mb-8">
      <h2 class="text-lg font-bold mb-2">ã‚¹ã‚³ã‚¢æ¨ç§»</h2>
      <canvas id="scoreChart"></canvas>
    </div>
    <!-- ===== æœ€æ–°å›ç­”ã®å†…è¨³ ===== -->
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-2">æœ€æ–°å›ç­”ã®å†…è¨³</h2>
      <table class="min-w-full border border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">è¨­å•</th>
            <th class="border px-2 py-1">å›ç­”</th>
            <th class="border px-2 py-1">ç‚¹æ•°</th>
          </tr>
        </thead>
        <tbody>
          {% for ans in latest_answers %}
          <tr>
            <td class="border px-2 py-1">{{ ans.code }}</td>
            <td class="border px-2 py-1">{{ ans.answer }}</td>
            <td class="border px-2 py-1 text-center
                {% if ans.point == 1 %}text-red-500
                {% elif ans.point == 0 %}text-green-500{% endif %}">
              {{ ans.point }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- ===== å›ç­”ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»JS ===== -->
  <script>
  (function () {
    const root = document.getElementById('answer-calendar');
    if (!root) return;
    const latestAtStr    = (root.dataset.latestAt || '').trim();        // "YYYY-MM-DD HH:MM:SS" or "-"
    const latestScoreStr = (root.dataset.latestScore || '').trim();      // "0".."12" or ""
    const labels         = JSON.parse(root.dataset.chartLabels || '[]'); // ["YYYY-MM-DD", ...]
    // ç”»åƒï¼ˆ/static/images/...ï¼‰
    const imgGood = root.dataset.imgGood || '/static/images/business_man1_4_laugh.png';
    const imgMid  = root.dataset.imgMid  || '/static/images/business_man1_1_smile.png';
    const imgBad  = root.dataset.imgBad  || '/static/images/business_man1_3_cry.png';
    // ç›´è¿‘ã‚¹ã‚³ã‚¢ã§å½“æœˆã‚¹ã‚¿ãƒ³ãƒ—ã®çµµæŸ„ã‚’æ±ºå®šï¼ˆç°¡æ˜“é‹ç”¨ï¼‰
    function stampImageByScore(score) {
      if (typeof score !== 'number' || isNaN(score)) return imgMid; // æœªè¨­å®šã¯ä¸­
      if (score >= 4) return imgBad;  // é«˜å¾—ç‚¹ã»ã©â€œè¦å¯¾å¿œâ€
      if (score >= 2) return imgMid;  // æ³¨æ„
      return imgGood;                 // è‰¯å¥½
    }
    const latestScore = latestScoreStr === '' ? NaN : Number(latestScoreStr);
    const STAMP_IMG = stampImageByScore(latestScore);
    const stampSet = new Set(labels); // å›ç­”ãŒã‚ã‚‹æ—¥ï¼ˆãã®æ—¥ã®æœ€æ–°ã®ã¿ï¼‰
    const grid   = document.getElementById('cal-grid');
    const title  = document.getElementById('cal-title');
    const note   = document.getElementById('cal-note');
    const prevBtn= document.getElementById('cal-prev');
    const nextBtn= document.getElementById('cal-next');
    let baseDate;
    if (latestAtStr && latestAtStr !== '-') {
      const [ymd] = latestAtStr.split(' ');
      const [Y, M] = ymd.split('-').map(Number);
      baseDate = new Date(Y, M - 1, 1);
    } else {
      const now = new Date();
      baseDate = new Date(now.getFullYear(), now.getMonth(), 1);
    }
    function ymdStr(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function drawCalendar(year, monthIndex) {
      title.textContent = `å›ç­”ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ${year}å¹´ ${monthIndex + 1}æœˆï¼‰`;
      const first = new Date(year, monthIndex, 1);
      const last  = new Date(year, monthIndex + 1, 0);
      const daysInMonth = last.getDate();
      const padStart = first.getDay(); // 0=æ—¥
      const cells = [];
      for (let i = 0; i < padStart; i++) {
        cells.push(`<div class="border rounded p-2 h-20 bg-gray-50"></div>`);
      }
      for (let d = 1; d <= daysInMonth; d++) {
        const cellDate = new Date(year, monthIndex, d);
        const iso = ymdStr(cellDate);
        const stamped = stampSet.has(iso);
        const inner = stamped
          ? `<img src="${STAMP_IMG}" alt="" class="stamp-img" />`
          : `<div class="h-full"></div>`;
        cells.push(`
          <div class="border rounded p-2 h-20 relative ${stamped ? 'ring-2 ring-blue-400' : ''}">
            <div class="text-[11px] text-gray-500 absolute top-1 left-1">${d}</div>
            <div class="flex items-center justify-center h-full">${inner}</div>
          </div>
        `);
      }
      const used = padStart + daysInMonth;
      const needPadEnd = (Math.ceil(used / 7) * 7) - used;
      for (let i = 0; i < needPadEnd; i++) {
        cells.push(`<div class="border rounded p-2 h-20 bg-gray-50"></div>`);
      }
      grid.innerHTML = cells.join('');
      const monthStr = `${year}-${String(monthIndex + 1).padStart(2, '0')}`;
      const hits = labels.filter(s => s.startsWith(monthStr));
      note.textContent = hits.length ? `ã“ã®æœˆã®å›ç­”æ—¥: ${hits.join(', ')}` : '';
    }
    drawCalendar(baseDate.getFullYear(), baseDate.getMonth());
    prevBtn.addEventListener('click', () => {
      baseDate.setMonth(baseDate.getMonth() - 1);
      drawCalendar(baseDate.getFullYear(), baseDate.getMonth());
    });
    nextBtn.addEventListener('click', () => {
      baseDate.setMonth(baseDate.getMonth() + 1);
      drawCalendar(baseDate.getFullYear(), baseDate.getMonth());
    });
  })();
  </script>
  <!-- ===== Chart.jsï¼ˆçŠ¶æ…‹è‰²åŒæœŸï¼‰ ===== -->
  <script>
    const labels = {{ chart_labels|tojson }};
    const values = {{ chart_values|tojson }};
    const pointColors = {{ chart_point_colors|tojson }};  // Python å´ã§ç”Ÿæˆ
    // yå€¤â†’è‰²ï¼ˆPython ã® risk_color_hex ã¨åˆã‚ã›ã‚‹ï¼‰
    const colorFor = (y) => {
      if (y >= 4) return '#EF4444';   // red-500ï¼ˆè¦å¯¾å¿œï¼‰
      if (y >= 2) return '#F59E0B';   // amber-500ï¼ˆæ³¨æ„ï¼‰
      return '#10B981';               // emerald-500ï¼ˆè‰¯å¥½ï¼‰
    };
    new Chart(document.getElementById('scoreChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'ã‚¹ã‚³ã‚¢',
          data: values,
          pointBackgroundColor: pointColors,
          pointBorderColor: pointColors,
          pointRadius: 4,
          borderWidth: 2,
          segment: { borderColor: ctx => colorFor(ctx.p0.parsed.y) },
          tension: 0.2,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, max: 12 } }
      }
    });
  </script>
</body>
</html> 
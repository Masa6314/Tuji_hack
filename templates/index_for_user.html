<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>{{ page_title }}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-6">
    <!-- タイトル -->
    <h1 class="text-2xl font-bold mb-6">{{ page_title }}</h1>
    <!-- ===== 個人の状態（横長カード） ===== -->
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-2">{{user_name}}の状態</h2>
      <div class="text-sm text-gray-500 mb-2">
        赤=要対応 / 黄=注意 / 緑=良好 / 灰=未回答
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {% for u in users_overview %}
        <div class="border rounded-lg p-4 shadow-sm
                    {% if u.risk == 'high' %}border-red-400 bg-red-50
                    {% elif u.risk == 'mid' %}border-yellow-400 bg-yellow-50
                    {% elif u.risk == 'low' %}border-green-400 bg-green-50
                    {% else %}border-gray-300 bg-gray-50{% endif %}">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold text-lg">{{ u.display_name }}</div>
            <span class="text-xs px-2 py-1 rounded
              {% if u.risk == 'high' %}bg-red-500 text-white
              {% elif u.risk == 'mid' %}bg-yellow-500 text-white
              {% elif u.risk == 'low' %}bg-green-500 text-white
              {% else %}bg-gray-400 text-white{% endif %}">
              {% if u.risk == 'high' %}要対応
              {% elif u.risk == 'mid' %}注意
              {% elif u.risk == 'low' %}良好
              {% else %}未回答{% endif %}
            </span>
          </div>
          <div class="text-sm text-gray-600">最終: {{ u.latest_at }}</div>
          <div class="mt-2 text-2xl font-bold">
            {{ u.latest_score if u.latest_score is not none else "-" }}
          </div>
          <div class="text-sm">{{ u.latest_status }}</div>
          <div class="mt-3 flex gap-2">
            <a href="/user/board/{{ u.external_token }}"
               class="bg-blue-500 text-white text-sm px-3 py-1 rounded">
               癒やしてあげる
            </a>
            <button onclick="navigator.clipboard.writeText(
            '{{ request.url_root }}user/{{ u.external_token }}')"
            class="border text-sm px-3 py-1 rounded flex items-center gap-1 transition duration-150 hover:bg-gray-100 active:scale-95">
            :クリップボード: リンクをコピー
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>


    <!-- ===== 直近の利用日数ランキング（TOP3） ===== -->
    <div class="bg-white rounded-lg shadow p-4 mb-8">
      <h2 class="text-lg font-bold mb-3">直近の利用日数ランキング（TOP3）</h2>
      <table class="min-w-full border border-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="border px-3 py-2 text-left">順位</th>
            <th class="border px-3 py-2 text-left">名前</th>
            <th class="border px-3 py-2 text-right">ログイン日数</th>
          </tr>
        </thead>
        <tbody>
          {% for row in login_ranking %}
          <tr class="hover:bg-gray-50">
            <td class="border px-3 py-2">
              {% if loop.index == 1 %}
                🥇: 1
              {% elif loop.index == 2 %}
                🥈: 2
              {% elif loop.index == 3 %}
                🥉: 3
              {% else %}
                {{ loop.index }}
              {% endif %}
            </td>
            <td class="border px-3 py-2">{{ row.display_name }}</td>
            <td class="border px-3 py-2 text-right">{{ row.days }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- ===== 回答スタンプ付きカレンダー（追加） ===== -->
    <div id="answer-calendar"
         class="bg-white rounded-lg shadow p-4 mb-8"
         data-latest-at="{{ latest_at | e }}"
         data-latest-score="{{ latest_score if latest_score is not none else '' }}"
         data-chart-labels='{{ chart_labels|tojson }}'
         data-img-good="{{ url_for('static', filename='images/business_man1_4_laugh.png') }}"
         data-img-mid ="{{ url_for('static', filename='images/business_man1_1_smile.png') }}"
         data-img-bad ="{{ url_for('static', filename='images/business_man1_3_cry.png') }}">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold" id="cal-title">回答カレンダー</h2>
        <div class="space-x-2 text-sm">
          <button id="cal-prev" class="px-3 py-1 rounded border hover:bg-gray-50">← 前月</button>
          <button id="cal-next" class="px-3 py-1 rounded border hover:bg-gray-50">翌月 →</button>
        </div>
      </div>
      <div class="grid grid-cols-7 text-center text-xs font-medium text-gray-600 mb-2">
        <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
      </div>
      <style>
        .stamp-img { width: 100px; height: 70px; object-fit: contain; margin: 0 auto; }
      </style>
      <div id="cal-grid" class="grid grid-cols-7 gap-1"></div>
      <div id="cal-note" class="mt-3 text-xs text-gray-500"></div>
    </div>
    <!-- ===== スコア推移（点＆線の色を状態色に同期） ===== -->
    <div class="bg-white rounded-lg shadow p-4 mb-8">
      <h2 class="text-lg font-bold mb-2">スコア推移</h2>
      <canvas id="scoreChart"></canvas>
    </div>
    <!-- ===== 最新回答の内訳 ===== -->
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-2">最新回答の内訳</h2>
      <table class="min-w-full border border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="border px-2 py-1">設問</th>
            <th class="border px-2 py-1">回答</th>
            <th class="border px-2 py-1">点数</th>
          </tr>
        </thead>
        <tbody>
          {% for ans in latest_answers %}
          <tr>
            <td class="border px-2 py-1">{{ ans.code }}</td>
            <td class="border px-2 py-1">{{ ans.answer }}</td>
            <td class="border px-2 py-1 text-center
                {% if ans.point == 1 %}text-red-500
                {% elif ans.point == 0 %}text-green-500{% endif %}">
              {{ ans.point }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- ===== 回答カレンダー描画JS ===== -->
  <script>
  (function () {
    const root = document.getElementById('answer-calendar');
    if (!root) return;
    const latestAtStr    = (root.dataset.latestAt || '').trim();        // "YYYY-MM-DD HH:MM:SS" or "-"
    const latestScoreStr = (root.dataset.latestScore || '').trim();      // "0".."12" or ""
    const labels         = JSON.parse(root.dataset.chartLabels || '[]'); // ["YYYY-MM-DD", ...]
    // 画像（/static/images/...）
    const imgGood = root.dataset.imgGood || '/static/images/business_man1_4_laugh.png';
    const imgMid  = root.dataset.imgMid  || '/static/images/business_man1_1_smile.png';
    const imgBad  = root.dataset.imgBad  || '/static/images/business_man1_3_cry.png';
    // 直近スコアで当月スタンプの絵柄を決定（簡易運用）
    function stampImageByScore(score) {
      if (typeof score !== 'number' || isNaN(score)) return imgMid; // 未設定は中
      if (score >= 4) return imgBad;  // 高得点ほど“要対応”
      if (score >= 2) return imgMid;  // 注意
      return imgGood;                 // 良好
    }
    const latestScore = latestScoreStr === '' ? NaN : Number(latestScoreStr);
    const STAMP_IMG = stampImageByScore(latestScore);
    const stampSet = new Set(labels); // 回答がある日（その日の最新のみ）
    const grid   = document.getElementById('cal-grid');
    const title  = document.getElementById('cal-title');
    const note   = document.getElementById('cal-note');
    const prevBtn= document.getElementById('cal-prev');
    const nextBtn= document.getElementById('cal-next');
    let baseDate;
    if (latestAtStr && latestAtStr !== '-') {
      const [ymd] = latestAtStr.split(' ');
      const [Y, M] = ymd.split('-').map(Number);
      baseDate = new Date(Y, M - 1, 1);
    } else {
      const now = new Date();
      baseDate = new Date(now.getFullYear(), now.getMonth(), 1);
    }
    function ymdStr(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }
    function drawCalendar(year, monthIndex) {
      title.textContent = `回答カレンダー（${year}年 ${monthIndex + 1}月）`;
      const first = new Date(year, monthIndex, 1);
      const last  = new Date(year, monthIndex + 1, 0);
      const daysInMonth = last.getDate();
      const padStart = first.getDay(); // 0=日
      const cells = [];
      for (let i = 0; i < padStart; i++) {
        cells.push(`<div class="border rounded p-2 h-20 bg-gray-50"></div>`);
      }
      for (let d = 1; d <= daysInMonth; d++) {
        const cellDate = new Date(year, monthIndex, d);
        const iso = ymdStr(cellDate);
        const stamped = stampSet.has(iso);
        const inner = stamped
          ? `<img src="${STAMP_IMG}" alt="" class="stamp-img" />`
          : `<div class="h-full"></div>`;
        cells.push(`
          <div class="border rounded p-2 h-20 relative ${stamped ? 'ring-2 ring-blue-400' : ''}">
            <div class="text-[11px] text-gray-500 absolute top-1 left-1">${d}</div>
            <div class="flex items-center justify-center h-full">${inner}</div>
          </div>
        `);
      }
      const used = padStart + daysInMonth;
      const needPadEnd = (Math.ceil(used / 7) * 7) - used;
      for (let i = 0; i < needPadEnd; i++) {
        cells.push(`<div class="border rounded p-2 h-20 bg-gray-50"></div>`);
      }
      grid.innerHTML = cells.join('');
      const monthStr = `${year}-${String(monthIndex + 1).padStart(2, '0')}`;
      const hits = labels.filter(s => s.startsWith(monthStr));
      note.textContent = hits.length ? `この月の回答日: ${hits.join(', ')}` : '';
    }
    drawCalendar(baseDate.getFullYear(), baseDate.getMonth());
    prevBtn.addEventListener('click', () => {
      baseDate.setMonth(baseDate.getMonth() - 1);
      drawCalendar(baseDate.getFullYear(), baseDate.getMonth());
    });
    nextBtn.addEventListener('click', () => {
      baseDate.setMonth(baseDate.getMonth() + 1);
      drawCalendar(baseDate.getFullYear(), baseDate.getMonth());
    });
  })();
  </script>
  <!-- ===== Chart.js（状態色同期） ===== -->
  <script>
    const labels = {{ chart_labels|tojson }};
    const values = {{ chart_values|tojson }};
    const pointColors = {{ chart_point_colors|tojson }};  // Python 側で生成
    // y値→色（Python の risk_color_hex と合わせる）
    const colorFor = (y) => {
      if (y >= 4) return '#EF4444';   // red-500（要対応）
      if (y >= 2) return '#F59E0B';   // amber-500（注意）
      return '#10B981';               // emerald-500（良好）
    };
    new Chart(document.getElementById('scoreChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'スコア',
          data: values,
          pointBackgroundColor: pointColors,
          pointBorderColor: pointColors,
          pointRadius: 4,
          borderWidth: 2,
          segment: { borderColor: ctx => colorFor(ctx.p0.parsed.y) },
          tension: 0.2,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, max: 12 } }
      }
    });
  </script>
</body>
</html> 